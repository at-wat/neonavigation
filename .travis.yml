dist: bionic
services: docker
language: bash
addons:
  apt:
    packages:
      - python-pip
cache:
  directories:
    - ${HOME}/.cache/docker
branches:
  only:
    - master

env:
  global:
    - PACKAGE_NAME=neonavigation
  matrix:
    - ROS_DISTRO_TARGET=kinetic COVERAGE_TEST=false  # note: Xenial has buggy version of gcc which doesn't calculate correct coverage.
    - ROS_DISTRO_TARGET=melodic COVERAGE_TEST=true

before_install:
  - .travis/load_cache.sh
  - pip install --user gh-pr-comment
script:
  - docker build
    -t ${PACKAGE_NAME}:${ROS_DISTRO_TARGET}
    -f .travis/Dockerfile
    --build-arg ROS_DISTRO=${ROS_DISTRO_TARGET}
    --pull=true ${TRAVIS_BUILD_DIR}
    || (gh-pr-comment "[[#${TRAVIS_BUILD_NUMBER}](${TRAVIS_BUILD_WEB_URL})] FAILED on ${ROS_DISTRO_TARGET}" "docker build failed"; false)
  - travis_retry wget --timeout=10 -O /tmp/codecovenv https://codecov.io/env
  - docker run --rm
    -e TRAVIS_PULL_REQUEST
    -e TRAVIS_REPO_SLUG
    -e TRAVIS_BOT_GITHUB_TOKEN
    -e COVERAGE_TEST
    -e GITHUB_API_URL_BASE
    -e TRAVIS_BUILD_NUMBER
    -e TRAVIS_BUILD_WEB_URL
    $(bash /tmp/codecovenv)
    ${PACKAGE_NAME}:${ROS_DISTRO_TARGET} /catkin_ws/src/${PACKAGE_NAME}/.travis/test.sh
  - bash -c "[ x${COVERAGE_TEST} != xtrue ] && .travis/save_cache.sh || true"
before_cache:
  - .travis/save_cache.sh ${PACKAGE_NAME}:${ROS_DISTRO_TARGET}

jobs:
  include:
    - stage: test
      env:
        - ROS_DISTRO_TARGET=noetic
      script:
        - BUILD_LINK="[[#${TRAVIS_BUILD_NUMBER}](${TRAVIS_BUILD_WEB_URL})]"
        - |
          docker run -it --rm \
            -v $(pwd):/src:ro \
            -t ${PACKAGE_NAME}:${ROS_DISTRO_TARGET} \
            alpineros/ros-abuild:3.11-noetic \
            && gh-pr-comment "${BUILD_LINK} PASSED on ${ROS_DISTRO_TARGET}" \
              "Tested on Alpine ROS" \
            || (gh-pr-comment "${BUILD_LINK} FAILED on ${ROS_DISTRO_TARGET}" \
              "Tested on Alpine ROS"; false) \
      before_cache:
        - .travis/save_cache.sh ${PACKAGE_NAME}:${ROS_DISTRO_TARGET}
    - stage: prerelease-test
      if: head_branch =~ ^release-.*$
      env:
        - ROS_DISTRO_TARGET=kinetic COVERAGE_TEST=false
      before_install: pip install --user gh-pr-comment
      script: .travis/prerelease_test.sh
    - stage: prerelease-test
      if: head_branch =~ ^release-.*$
      env:
        - ROS_DISTRO_TARGET=melodic COVERAGE_TEST=false
      before_install: pip install --user gh-pr-comment
      script: .travis/prerelease_test.sh
    - stage: prerelease-test
      if: head_branch =~ ^release-.*$
      env:
        - ROS_DISTRO_TARGET=noetic COVERAGE_TEST=false
      before_install: pip install --user gh-pr-comment
      script: .travis/prerelease_test.sh
